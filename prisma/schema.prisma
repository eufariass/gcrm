// Geum Imobiliária - Prisma Schema
// Sistema de CRM/ERP para Imobiliárias

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  ADMIN
  MANAGER
  BROKER
}

enum PropertyType {
  APARTMENT
  HOUSE
  COMMERCIAL
  LAND
  RURAL
}

enum PropertyStatus {
  AVAILABLE
  RESERVED
  SOLD
  RENTED
}

enum TransactionType {
  SALE
  RENT
  SALE_RENT
}

enum LeadStatus {
  NEW
  CONTACT
  VISIT
  PROPOSAL
  CLOSING
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  PORTAL
  REFERRAL
  META_ADS
  GOOGLE_ADS
  ORGANIC
  OTHER
}

enum InteractionType {
  CALL
  EMAIL
  WHATSAPP
  VISIT
  MEETING
  NOTE
}

enum ContractType {
  SALE
  RENT
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

// ==========================================
// USER - Usuários do Sistema
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  phone         String?
  avatar        String?
  role          UserRole  @default(BROKER)
  creci         String?   // Registro CRECI do corretor
  isActive      Boolean   @default(true)
  
  // Auth
  emailVerified DateTime?
  password      String?
  
  // Relations
  properties    Property[]    @relation("PropertyBroker")
  leads         Lead[]        @relation("LeadBroker")
  interactions  Interaction[]
  contracts     Contract[]    @relation("ContractBroker")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

// ==========================================
// PROPERTY - Imóveis
// ==========================================

model Property {
  id            String          @id @default(cuid())
  
  // Identificação
  code          String          @unique // Código interno (ex: "GE001")
  title         String
  description   String?         @db.Text
  
  // Tipo e Status
  type          PropertyType
  status        PropertyStatus  @default(AVAILABLE)
  transactionType TransactionType
  
  // Valores
  salePrice     Decimal?        @db.Decimal(12, 2)
  rentPrice     Decimal?        @db.Decimal(10, 2)
  condoFee      Decimal?        @db.Decimal(8, 2)  // Condomínio
  iptu          Decimal?        @db.Decimal(8, 2)  // IPTU anual
  
  // Características
  area          Float           // Área em m²
  builtArea     Float?          // Área construída em m²
  bedrooms      Int?
  bathrooms     Int?
  suites        Int?
  parkingSpaces Int?
  
  // Localização
  address       String
  number        String?
  complement    String?
  neighborhood  String
  city          String
  state         String          @db.VarChar(2)
  zipCode       String          @db.VarChar(9)
  latitude      Float?
  longitude     Float?
  
  // Mídia
  images        PropertyImage[]
  featuredImage String?         // URL da imagem principal
  videoUrl      String?
  virtualTour   String?         // URL do tour virtual
  
  // Características adicionais
  features      String[]        // Array de características (piscina, churrasqueira, etc)
  
  // SEO
  slug          String          @unique
  metaTitle     String?
  metaDescription String?
  
  // Relacionamentos
  brokerId      String
  broker        User            @relation("PropertyBroker", fields: [brokerId], references: [id])
  contracts     Contract[]
  
  // Timestamps
  publishedAt   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([status, transactionType])
  @@index([city, neighborhood])
  @@index([type, bedrooms])
  @@index([salePrice])
  @@index([rentPrice])
  @@map("properties")
}

model PropertyImage {
  id          String   @id @default(cuid())
  url         String
  alt         String?
  order       Int      @default(0)
  
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@map("property_images")
}

// ==========================================
// LEAD - Leads/Clientes Potenciais
// ==========================================

model Lead {
  id            String      @id @default(cuid())
  
  // Dados básicos
  name          String
  email         String
  phone         String
  
  // Status no Pipeline
  status        LeadStatus  @default(NEW)
  source        LeadSource  @default(WEBSITE)
  
  // Preferências (para Matching Engine)
  preferences   Json?       // { minBedrooms, maxPrice, neighborhoods[], propertyTypes[] }
  
  // Relacionamentos
  brokerId      String?
  broker        User?       @relation("LeadBroker", fields: [brokerId], references: [id])
  interactions  Interaction[]
  contracts     Contract[]
  
  // Métricas
  score         Int         @default(0) // Lead scoring
  
  // Timestamps
  lastContactAt DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status])
  @@index([source])
  @@index([brokerId])
  @@map("leads")
}

// ==========================================
// INTERACTION - Histórico de Interações
// ==========================================

model Interaction {
  id          String          @id @default(cuid())
  
  type        InteractionType
  title       String
  description String?         @db.Text
  
  // Agendamento (para visitas/reuniões)
  scheduledAt DateTime?
  completedAt DateTime?
  
  // Relacionamentos
  leadId      String
  lead        Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  
  createdAt   DateTime        @default(now())
  
  @@index([leadId])
  @@index([scheduledAt])
  @@map("interactions")
}

// ==========================================
// CONTRACT - Contratos
// ==========================================

model Contract {
  id            String         @id @default(cuid())
  
  type          ContractType
  status        ContractStatus @default(DRAFT)
  
  // Valores
  value         Decimal        @db.Decimal(12, 2)
  commission    Decimal?       @db.Decimal(10, 2)
  
  // Datas
  startDate     DateTime
  endDate       DateTime?      // NULL para vendas
  signedAt      DateTime?
  
  // Documentos
  documentUrl   String?
  
  // Relacionamentos
  propertyId    String
  property      Property       @relation(fields: [propertyId], references: [id])
  
  leadId        String
  lead          Lead           @relation(fields: [leadId], references: [id])
  
  brokerId      String
  broker        User           @relation("ContractBroker", fields: [brokerId], references: [id])
  
  // Observações
  notes         String?        @db.Text
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@index([status])
  @@index([propertyId])
  @@index([leadId])
  @@map("contracts")
}
