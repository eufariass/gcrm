// Geum Imobiliária - Prisma Schema
// Sistema de CRM/ERP para Imobiliárias

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  ADMIN
  MANAGER
  BROKER
}

enum PropertyType {
  APARTMENT
  HOUSE
  COMMERCIAL
  LAND
  RURAL
}

enum PropertyStatus {
  AVAILABLE
  RESERVED
  SOLD
  RENTED
}

enum TransactionType {
  SALE
  RENT
  SALE_RENT
}

enum LeadStatus {
  NEW
  CONTACT
  VISIT
  PROPOSAL
  CLOSING
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  PORTAL
  REFERRAL
  META_ADS
  GOOGLE_ADS
  ORGANIC
  OTHER
}

enum InteractionType {
  CALL
  EMAIL
  WHATSAPP
  VISIT
  MEETING
  NOTE
}

enum ContractType {
  SALE
  RENT
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

// ==========================================
// USER - Usuários do Sistema
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  phone         String?
  avatar        String?
  image         String?
  role          UserRole  @default(BROKER)
  creci         String?
  isActive      Boolean   @default(true)
  
  emailVerified DateTime?
  password      String?
  
  // NextAuth relations
  accounts      Account[]
  sessions      Session[]
  
  // Business relations
  properties    Property[]    @relation("PropertyBroker")
  leads         Lead[]        @relation("LeadBroker")
  interactions  Interaction[]
  contracts     Contract[]    @relation("ContractBroker")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

// ==========================================
// NEXTAUTH - OAuth & Sessions
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// PROPERTY - Imóveis
// ==========================================

model Property {
  id              String          @id @default(cuid())
  code            String          @unique
  title           String
  description     String?         @db.Text
  type            PropertyType
  status          PropertyStatus  @default(AVAILABLE)
  transactionType TransactionType
  
  salePrice       Decimal?        @db.Decimal(12, 2)
  rentPrice       Decimal?        @db.Decimal(10, 2)
  condoFee        Decimal?        @db.Decimal(8, 2)
  iptu            Decimal?        @db.Decimal(8, 2)
  
  area            Float
  builtArea       Float?
  bedrooms        Int?
  bathrooms       Int?
  suites          Int?
  parkingSpaces   Int?
  
  address         String
  number          String?
  complement      String?
  neighborhood    String
  city            String
  state           String          @db.VarChar(2)
  zipCode         String          @db.VarChar(9)
  latitude        Float?
  longitude       Float?
  
  images          PropertyImage[]
  featuredImage   String?
  videoUrl        String?
  virtualTour     String?
  features        String[]
  
  slug            String          @unique
  metaTitle       String?
  metaDescription String?
  
  brokerId        String
  broker          User            @relation("PropertyBroker", fields: [brokerId], references: [id])
  contracts       Contract[]
  
  publishedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([status, transactionType])
  @@index([city, neighborhood])
  @@index([type, bedrooms])
  @@index([salePrice])
  @@index([rentPrice])
  @@map("properties")
}

model PropertyImage {
  id          String   @id @default(cuid())
  url         String
  alt         String?
  order       Int      @default(0)
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@map("property_images")
}

// ==========================================
// LEAD - Leads/Clientes Potenciais
// ==========================================

model Lead {
  id            String      @id @default(cuid())
  name          String
  email         String
  phone         String
  status        LeadStatus  @default(NEW)
  source        LeadSource  @default(WEBSITE)
  preferences   Json?
  brokerId      String?
  broker        User?       @relation("LeadBroker", fields: [brokerId], references: [id])
  interactions  Interaction[]
  contracts     Contract[]
  score         Int         @default(0)
  lastContactAt DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status])
  @@index([source])
  @@index([brokerId])
  @@map("leads")
}

// ==========================================
// INTERACTION - Histórico de Interações
// ==========================================

model Interaction {
  id          String          @id @default(cuid())
  type        InteractionType
  title       String
  description String?         @db.Text
  scheduledAt DateTime?
  completedAt DateTime?
  leadId      String
  lead        Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  createdAt   DateTime        @default(now())
  
  @@index([leadId])
  @@index([scheduledAt])
  @@map("interactions")
}

// ==========================================
// CONTRACT - Contratos
// ==========================================

model Contract {
  id            String         @id @default(cuid())
  type          ContractType
  status        ContractStatus @default(DRAFT)
  value         Decimal        @db.Decimal(12, 2)
  commission    Decimal?       @db.Decimal(10, 2)
  startDate     DateTime
  endDate       DateTime?
  signedAt      DateTime?
  documentUrl   String?
  propertyId    String
  property      Property       @relation(fields: [propertyId], references: [id])
  leadId        String
  lead          Lead           @relation(fields: [leadId], references: [id])
  brokerId      String
  broker        User           @relation("ContractBroker", fields: [brokerId], references: [id])
  notes         String?        @db.Text
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@index([status])
  @@index([propertyId])
  @@index([leadId])
  @@map("contracts")
}
